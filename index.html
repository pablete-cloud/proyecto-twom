<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Libro de los Textos - This War of Mine</title>
  <style>
    :root {
      --primary-color: #660000;
      --secondary-color: #2c2c2c;
      --accent-color: #b8860b;
      --text-color: #e0e0e0;
      --background-color: #0f0f0f;
      --button-hover: #500000;
      --border-color: #444444;
    }

    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 15px;
      padding-bottom: 50px;
      background: var(--background-color) url("twom-files/asfalt-dark.png");
      color: var(--text-color);
      line-height: 1.6;
      background-blend-mode: multiply;
    }

    h1 {
      color: var(--accent-color);
      text-align: center;
      margin: 1.5rem 0;
      font-size: 2.2rem;
      letter-spacing: -1px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
    }

    input[type="number"] {
      padding: 12px;
      font-size: 16px;
      width: 120px;
      border: 2px solid var(--border-color);
      border-radius: 5px;
      background: #2a2a2a;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    input[type="number"]:focus {
      border-color: var(--accent-color);
      outline: none;
      box-shadow: 0 0 8px rgba(212,175,55,0.3);
    }

    button {
      padding: 12px 25px;
      font-size: 16px;
      cursor: pointer;
      margin: 8px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background-color: var(--primary-color);
      color: white;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
    }

    button:hover {
      background-color: var(--button-hover);
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }

    .text-container {
      margin: 20px auto;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      max-width: 800px;
      font-size: 16px;
      position: relative;
      overflow: hidden;
    }

    .text-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: -50%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent 25%, 
        rgba(139,0,0,0.2) 50%, 
        transparent 75%);
      animation: scanline 8s linear infinite;
      pointer-events: none;
    }

    @keyframes scanline {
      0% { transform: translateX(0); }
      100% { transform: translateX(50%); }
    }

    .button-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 25px 0;
    }

    .input-container {
      text-align: center;
      margin: 25px 0;
    }

    .input-container label {
      font-size: 16px;
      margin-right: 10px;
      color: var(--accent-color);
    }

    .font-size-container {
      text-align: center;
      margin: 20px 0;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      overflow-y: auto;
    }

    .modal-content {
      background-color: #2a2a2a;
      margin: 20px auto;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      border: 1px solid var(--border-color);
      position: relative;
      max-height: calc(100vh - 140px);
      overflow-y: auto;
    }

    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      color: var(--accent-color);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: #2a2a2a;
      padding: 0 10px;
      border-radius: 4px;
      z-index: 2;
    }

    

    

    /* Visor de textos: oculto hasta que haya contenido (no debe verse caja ni X) */
    #textDisplay { position: relative; display: none; }
    #textContent { padding-top: 35px; }
    #close-text-btn { display: none; }

a {
      color: var(--accent-color);
      text-decoration: underline;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    a:hover {
      color: #ffd700;
      text-decoration: none;
    }

    strong {
      color: var(--accent-color);
    }

    em {
      color: #27ae60;
    }

    #audio-player-container {
      position: relative; /* Cambiado de fixed a relative */
      margin: 20px auto; /* Centrado */
      padding: 20px;
      background: #2a2a2a;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-width: 800px;
      width: 100%;
      z-index: 1000;
    }
    #player-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    #cover-art {
      flex-shrink: 0;
    }

    #cover-art img {
      width: 200px;
      height: 200px;
      object-fit: cover;
      border: 2px solid var(--border-color);
      border-radius: 4px;
    }

    #player-details {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #song-info {
      font-size: 14px;
      color: var(--text-color);
    }

    #playlist {
      padding: 8px;
      font-size: 14px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: #2a2a2a;
      color: var(--text-color);
    }

    #control-buttons button {
      padding: 10px 18px;
      font-size: 14px;
    }

    #playlist option.playing {
      font-weight: bold;
      color: var(--accent-color);
    }

    #additional-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-color);
    }

    #additional-controls select,
    #additional-controls input[type="range"] {
      padding: 5px;
      background: #2a2a2a;
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
    }

    
    /* Estados visibles para Repeat / Shuffle */
    #additional-controls button.toggle-btn {
      position: relative;
      padding: 10px 14px;
      min-width: 54px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: #1f1f1f;
      color: var(--text-color);
      line-height: 1;
      opacity: 0.85;
    }
    #additional-controls button.toggle-btn::after {
      content: attr(data-state-label);
      display: block;
      font-size: 11px;
      line-height: 1.1;
      margin-top: 6px;
      color: #bdbdbd;
      white-space: nowrap;
    }
    #additional-controls button.toggle-btn.active,
    #additional-controls button.toggle-btn.is-active {
      opacity: 1;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(184, 134, 11, 0.25);
    }
    #additional-controls button.toggle-btn.active::after,
    #additional-controls button.toggle-btn.is-active::after {
      color: var(--accent-color);
      font-weight: 700;
    }





    

    /* Ajuste para que la X del texto use el mismo estilo que los modales */
    #textDisplay {
      position: relative;
      padding-top: 10px;
    }

.pagination-controls {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      margin-top: 20px;
      padding: 10px 0;
      border-top: 1px solid var(--border-color);
    }

    /* Fijamos la columna de cada elemento para que el texto no ‚Äúsalte‚Äù cuando se oculte un bot√≥n */
    .pagination-controls #prevPageBtn { grid-column: 1; justify-self: start; }
    .pagination-controls .page-info { grid-column: 2; justify-self: center; text-align: center; }
    .pagination-controls #nextPageBtn { grid-column: 3; justify-self: end; }

    .page-info {
      color: var(--accent-color);
      font-size: 14px;
    }

    @media (max-width: 768px) {
      #cover-art img {
        width: 100px;
        height: 100px;
      }
    }

    @media (max-width: 480px) {
      #control-buttons button {
        padding: 8px 14px;
        font-size: 12px;
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
        margin: 1rem 0;
      }
      
      .button-container button {
        width: 100%;
        max-width: none;
        margin: 5px 0;
      }
      
      .text-container {
        margin: 15px;
        padding: 15px;
        font-size: 15px;
      }
      
      input[type="number"] {
        width: 100%;
        max-width: 200px;
        margin-bottom: 10px;
      }
      
      .input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      button {
        font-size: 14px;
        padding: 10px 20px;
      }
      
      .modal-content {
        padding: 15px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
      }
      
      .close {
        font-size: 24px;
        top: 5px;
        right: 10px;
      }
    }
  
#additional-controls button{
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  transition: 0.2s ease;
}
#additional-controls button:hover{
  transform: translateY(-1px);
}
#additional-controls button.active{
  outline: 2px solid var(--accent);
}

/*
 * Estilo para los enlaces num√©ricos provenientes de Google¬†Sheets. A√±ade un aspecto
 * de bot√≥n que armoniza con el resto de la interfaz. Se aplica solo a los
 * enlaces que incluyan el atributo `data-id`, utilizado para invocar showText.
 */
#textContent a[data-id] {
  display: inline-block;
  padding: 8px 16px;
  margin: 4px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  background-color: var(--primary-color);
  color: white;
  text-decoration: none;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

#textContent a[data-id]:hover {
  background-color: var(--button-hover);
  transform: translateY(-2px);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
}

</style>
<script type="text/javascript" nonce="fdecca09623a4eb5abd05c1cd50" src="//local.adguard.org?ts=1771590349265&amp;type=content-script&amp;dmn=chatgpt.com&amp;pth=%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-B1sCEnRNHkYryT9rXcEcjm%26ts%3D492114%26p%3Dfs%26cid%3D1%26sig%3Def557dc8de6958e97c8e082d969cf3095070637944fd809780e286742942becd%26v%3D0&amp;app=com.google.Chrome&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script>
<script type="text/javascript" nonce="fdecca09623a4eb5abd05c1cd50" src="//local.adguard.org?ts=1771590349265&amp;name=AdGuard%20Extra&amp;type=user-script"></script></head>
<body>
  <h1>Libro de los Textos - This War of Mine</h1>
  
  <div class="button-container" style="margin-bottom: 60px;">
    <button onclick="showModal([
      '<strong>PREPARACI√ìN DE LA PARTIDA - Ver <button onclick=&quot;showText(100); closeModal(); return false;&quot;>100</button></strong><br><br><em>1. Personajes - Ver <button onclick=&quot;showText(101); closeModal(); return false;&quot;>101</button></em><br><br>- Baraja las cartas de personajes y roba 3 (1 roja y 2 negras).<br><br>- Asigna una ficha de Hambre (de valor inicial 2) a cada personaje.',
     '<strong>PREPARACI√ìN DE LA PARTIDA - Ver <button onclick=&quot;showText(100); closeModal(); return false;&quot;>100</button></strong><br><br><em>2. Mazos de cartas</em><br><br>- Coloca cada mazo en su lugar correspondiente.<br><br>- Separa las cartas con esquina roja de los mazos Incursiones Nocturnas y Habitantes.',
     '<strong>PREPARACI√ìN DE LA PARTIDA - Ver <button onclick=&quot;showText(100); closeModal(); return false;&quot;>100</button></strong><br><br><em>3. Refugio - Ver <button onclick=&quot;showText(110); closeModal(); return false;&quot;>110</button></em><br><br>- Baraja las cartas del Refugio y rep√°rtelas aleatoriamente en los espacios adecuados seg√∫n el tipo de carta.',
     '<strong>PREPARACI√ìN DE LA PARTIDA - Ver <button onclick=&quot;showText(100); closeModal(); return false;&quot;>100</button></strong><br><br><em>4. Acontecimientos</em><br><br>Crea el mazo de Acontecimientos siguiendo este orden:<br><br>- Baraja 3 cartas de Acontecimiento Final y col√≥calas en su espacio.<br><br>- Coloca la carta Cap√≠tulo III encima del mazo.<br><br>- Roba 4 cartas de Acontecimiento y col√≥calas encima del mazo.<br><br>- Coloca la carta Cap√≠tulo II encima del mazo.<br><br>- Roba 3 cartas de Acontecimiento y col√≥calas encima del mazo.<br><br>- Coloca la carta Cap√≠tulo I encima del mazo.',
      '<strong>PREPARACI√ìN DE LA PARTIDA</strong><br><br><em>5. Almac√©n</em><br><br>- Coloca en el Almac√©n los siguientes objetos:<br><br>- 1 ganz√∫a<br><br>- 1 pala<br><br>- 3 comidas crudas<br><br>- 4 piezas<br><br>- 4 maderas<br><br>- 2 fichas de agua'
    ])">PREPARACI√ìN</button>
    
    <button onclick="showModal([
      '<strong>POR LA MA√ëANA - Ver <button onclick=&quot;showText(200); closeModal(); return false;&quot;>200</button></strong><br><br><em>1. Acontecimiento</em><br><br>- Roba y resuelve la carta superior del mazo de Acontecimientos.',
      '<strong>ACCIONES DIURNAS - Ver <button onclick=&quot;showText(300); closeModal(); return false;&quot;>300</button></strong><br><br><em>1. Etapa de acci√≥n</em><br><br>- Hay tres etapas de acci√≥n.<br><br>- Cada personaje realiza una √∫nica acci√≥n en cada etapa de acci√≥n.<br><br>- Las fichas de estado de cada personaje muestran el n√∫mero de etapas de acci√≥n disponibles para dicho personaje.',
      '<strong>ANOCHECER - Ver <button onclick=&quot;showText(400); closeModal(); return false;&quot;>400</button></strong><br><br><em>1. Agua</em><br><br>- Bebe 1 ficha de agua por cada personaje.<br><br>Si no bebes:<br><br>- Resultado 1-5 en dado negro: aumenta el Hambre en 1.<br><br>- Resultado 6-10 en dado negro: aumenta la Tristeza en 1.',
      '<strong>ANOCHECER - Ver <button onclick=&quot;showText(400); closeModal(); return false;&quot;>400</button></strong><br><br><em>2. Hambre</em><br><br>Come al menos 1 comida:<br><br>- Comida enlatada: reduce el Hambre en 2.<br><br>- Comida cruda: reduce el Hambre en 1.<br><br>- Verduras: no afecta el Hambre.<br><br>Sin comer: aumenta el Hambre en 1.',
      '<strong>NOCHE - Ver <button onclick=&quot;showText(500); closeModal(); return false;&quot;>500</button></strong><br><br><em>1. Dormir</em><br><br>- Cama : M√°ximo un personaje por cama, reduce la Fatiga a 0.<br><br>- Suelo : Reduce la Fatiga en 2 para cualquier n√∫mero de personajes.<br><br>- Montar Guardia : Aumenta la Fatiga en 1 para cualquier n√∫mero de personajes.<br><br>Importante: Si nadie monta guardia, lee la entrada <button onclick=&quot;showText(333); closeModal(); return false;&quot;>333</button> del Libro de Textos.<br><br>- Salir a Buscar : Coloca hasta 3 personajes en el espacio Pila de Hallazgos, aumentando la Fatiga en 1.',
      '<strong>B√öSQUEDA - ver <button onclick=&quot;showText(600); closeModal(); return false;&quot;>600</button></strong><br><br><em>1. Elegir Lugar</em><br><br>- Elige 1 de los 3 lugares disponibles y mueve a los personajes al lugar.',
      '<strong>B√öSQUEDA - ver <button onclick=&quot;showText(600); closeModal(); return false;&quot;>600</button></strong><br><br><em>2. Elegir Equipo</em><br><br>Elige armas y/o equipo del Almac√©n para la b√∫squeda.<br><br>- Tambi√©n puedes llevar otras fichas para hacer intercambios (considerando la capacidad de carga de los personajes).',
      '<strong>B√öSQUEDA - ver <button onclick=&quot;showText(600); closeModal(); return false;&quot;>600</button></strong><br><br><em>3. Ruido</em><br><br>- Coloca la ficha de Ruido en 1.<br><br>- Cuando falles una tirada de Ruido, resuelve una carta de Habitantes y reinicia la ficha de Ruido a 1.',
      '<strong>INCURSI√ìN NOCTURNA - Ver <button onclick=&quot;showText(700); closeModal(); return false;&quot;>700</button></strong><br><br><em>1. Elegir Armas</em><br><br>- Cada personaje en el espacio de Guardia puede utilizar un arma del Almac√©n coloc√°ndola en el espacio de Guardia.',
      '<strong>INCURSI√ìN NOCTURNA - Ver <button onclick=&quot;showText(700); closeModal(); return false;&quot;>700</button></strong><br><br><em>2. Resolver Incursi√≥n Nocturna</em><br><br>- Roba y resuelve la carta superior del mazo de Incursiones Nocturnas.<br><br>- Da√±o : Es la cantidad de fichas/recursos robados del Almac√©n.<br><br>- Heridas : Es la cantidad de Heridas que deben distribuirse entre los personajes que montan guardia.<br><br>- Reduce el Da√±o y las Heridas lanzando el dado correspondiente al arma de cada personaje que monta guardia.<br><br>- Cada ficha de Cerramiento reduce en 1 el n√∫mero de Da√±o o Heridas.',
      '<strong>INCURSI√ìN NOCTURNA - Ver <button onclick=&quot;showText(700); closeModal(); return false;&quot;>700</button></strong><br><br><em>3. Oleada de Delitos</em><br><br>- Si quedan cartas apartadas con la esquina superior roja de los mazos Incursi√≥n Nocturna y Habitantes, a√±ade 2 cartas en cualquier combinaci√≥n a sus mazos.',
      '<strong>AMANECER - Ver <button onclick=&quot;showText(800); closeModal(); return false;&quot;>800</button></strong><br><br><em>1. Vuelve el Grupo de B√∫squeda</em><br><br>- Coloca los personajes del grupo de b√∫squeda en el Refugio y las fichas/recursos que traen en el Almac√©n.',
      '<strong>AMANECER - Ver <button onclick=&quot;showText(800); closeModal(); return false;&quot;>800</button></strong><br><br><em>2. Asignar Medicinas y Vendas</em><br><br>- Si en el Almac√©n hay Medicinas/Hierbas Medicinales/Vendas, se pueden asignar a las cartas de los personajes que est√©n enfermos/heridos.<br><br>- Una vez asignados, espera a que un efecto del juego las retire.',
      '<strong>AMANECER - Ver <button onclick=&quot;showText(800); closeModal(); return false;&quot;>800</button></strong><br><br><em>3. Destino</em><br><br>- Antes o despu√©s de resolver una carta de Destino, puedes utilizar Alcohol Casero/Alcohol 100% para reducir la Tristeza en 1 de los personajes, aumentando su Fatiga en 2/1.<br><br>- Roba y resuelve una carta de Destino.',
      '<strong>AMANECER - Ver <button onclick=&quot;showText(800); closeModal(); return false;&quot;>800</button></strong><br><br><em>4. Acci√≥n Narrativa</em><br><br>- Roba 2 cartas de Acci√≥n Narrativa, l√©elas y elige una.<br><br>- Devuelve la otra carta al mazo y bar√°jala.',
      '<strong>AMANECER - Ver <button onclick=&quot;showText(800); closeModal(); return false;&quot;>800</button></strong><br><br><em>5. La Muerte Entre Nosotros</em><br><br>- Si alg√∫n personaje ha muerto o abandonado el grupo durante el d√≠a jugado, tira el dado negro y compara el resultado con la Empat√≠a de cada personaje.<br><br>- Si el resultado es igual o menor a la empat√≠a de un jugador, ese jugador aumenta su Tristeza en 2.'
    ])">TURNO</button>

    <button onclick="showModal([
      '<strong>COMBATE - Ver <button onclick=&quot;showText(900); closeModal(); return false;&quot;>900</button></strong><br><br><em>1. Colocaci√≥n de Fichas</strong></em><br><br>- Coloca las fichas A, B y/o C en los espacios de la primera columna de la Tabla de Combate dependiendo de las armas que lleven.',
      '<strong>COMBATE - Ver <button onclick=&quot;showText(900); closeModal(); return false;&quot;>900</button></strong><br><br><em>2. Asaltos</strong></em><br><br>- El combate se divide en asaltos.<br><br>- En cada asalto, tira un dado de Combate por cada personaje y enemigo.',
      '<strong>COMBATE - Ver <button onclick=&quot;showText(900); closeModal(); return false;&quot;>900</button></strong><br><br><em>3. Armas</strong></em><br><br>- Las armas de fuego se resuelven antes que las dem√°s.<br><br>- Debes poseer munici√≥n para utilizar un arma de fuego.<br><br>- Si un enemigo no tiene munici√≥n, se reubica en la Tabla de Combate.<br><br>- Fusil de Asalto : Puedes descartar 2 fichas de munici√≥n para lanzar dos dados.<br><br>- Escopeta : Si la tirada de dado sale <<Perdigones>>, el objetivo muere (resolviendo Incursiones Nocturnas, ese resultado anula la carta).<br><br>- Hacha : Si la tirada de dado sale <<Hacha>>, el objetivo muere (resolviendo Incursiones Nocturnas, ese resultado anula la carta).',
      '<strong>COMBATE - Ver <button onclick=&quot;showText(900); closeModal(); return false;&quot;>900</button></strong><br><br><em>4. Resultado y Pericia</strong></em><br><br>- La cantidad de iconos (pu√±o, cuchillo, mirilla) que obtengas indica el n√∫mero de Heridas infligidas.<br><br>- Distribuye estas heridas entre los participantes del combate como desees.<br><br>- Si en la tirada de alg√∫n personaje obtienes <<¬ß>>, debes elegir entre fallo o leer la parte inferior de una carta de Destino.<br><br>- La Pericia de cada personaje/enemigo indica cu√°ntas veces puedes repetir la tirada de dado.',
      '<strong>COMBATE - Ver <button onclick=&quot;showText(900); closeModal(); return false;&quot;>900</button></strong><br><br><em>5. Huir y Ataque por la Espalda</strong></em><br><br>- Antes de cada asalto de Combate, los personajes pueden huir.<br><br>- En ese caso, los enemigos atacan por la espalda.<br><br>- En un ataque por la espalda, solo tira los dados el bando que ataca.<br><br>- Despu√©s de resolver la huida, los personajes abandonan el lugar de b√∫squeda y pasan a la etapa de Elegir Hallazgos.<br><br>- Si el ataque por la espalda se hace desde un escondrijo y queda alg√∫n enemigo con vida, contin√∫a con un combate normal.',
      '<strong>COMBATE - Ver <button onclick=&quot;showText(900); closeModal(); return false;&quot;>900</button></strong><br><br><em>6. Muerte de Enemigos</strong></em><br><br>- Tras la muerte de un enemigo (que no sea Mat√≥n), tira el dado negro y compara el resultado con la Empat√≠a de los personajes presentes.<br><br>- Si el resultado es igual o menor a la empat√≠a, el personaje aumenta su Tristeza en 1.'
    ])">COMBATE</button>

    <button onclick="showModal([
      '<strong>INTERCAMBIOS - Ver <button onclick=&quot;showText(901); closeModal(); return false;&quot;>901</button></strong><br><br><em>1. Comisi√≥n</strong></em><br><br>- Antes de empezar un Intercambio, hay que pagar la comisi√≥n de intercambio (si la hubiera).',

      '<strong>INTERCAMBIOS - Ver <button onclick=&quot;showText(901); closeModal(); return false;&quot;>901</button></strong><br><br><em>2. Recursos</strong></em><br><br>- El agua, la madera y las piezas no pueden formar parte de un intercambio.',

      '<strong>INTERCAMBIOS - Ver <button onclick=&quot;showText(901); closeModal(); return false;&quot;>901</button></strong><br><br><em>3. Mazo Desconocido y Exploraci√≥n</strong></em><br><br>- Roba tantas cartas de Exploraci√≥n como indique el lugar de b√∫squeda escogido y col√≥calas en el espacio Desconocido.<br><br>- Resuelve todas las cartas por turnos, una carta por jugador.<br><br>- Si alguien muere durante la exploraci√≥n, lee la entrada <button onclick=&quot;showText(266); closeModal(); return false;&quot;>266</button> del Libro de Textos.',

      '<strong>INTERCAMBIOS - Ver <button onclick=&quot;showText(901); closeModal(); return false;&quot;>901</button></strong><br><br><em>4. Elegir Hallazgos</strong></em><br><br>- Devuelve todas las cartas a sus respectivos mazos y bar√°jalos.<br><br>- A√±ade la cantidad de recursos (agua, madera, pieza) que desees a la Pila de Hallazgos.<br><br>- Elegid todo lo que pod√°is cargar seg√∫n la capacidad de carga de los personajes.<br><br>- Descarta el resto.'
    ])">INTERCAMBIOS</button>
      
      <button onclick="showText(10); return false;">GUARDAR</button>
  </div>
  
  <div class="button-container" style="margin-bottom: 60px;">
    <button onclick="showModal([
      '<strong>ACERCA DE LAS REGLAS</strong><br><br>Las reglas del tablero pueden modificar las reglas del Diario.<br><br>Las reglas de las cartas pueden modificar las reglas del tablero y las reglas del Diario.',
      'A su vez, las reglas de los textos pueden modificar solo lo anterior.<br><br>Cuando diversas reglas indiquen que deber√≠ais llevar a cabo una acci√≥n al mismo tiempo (por ejemplo, al inicio de la fase X), tendr√©is que decidir la secuencia de dichas acciones.',
      '<strong><em>This War of Mine: el juego</em></strong> de tablero es grande, complejo y elaborado. A buen seguro habr√° situaciones con las que os encontrar√©is que no est√°n cubiertas por las reglas y que despertar√°n dudas no resueltas, ni siquiera por los textos de las Preguntas Frecuentes.',
      'En dicha situaci√≥n, tendr√©is que usar el sentido com√∫n y elegir una interpretaci√≥n que refleje lo mejor posible lo que hubiera pasado en el mundo real.<br><br>Muchas de las reglas est√°n ocultas, y s√≥lo las encontrar√©is durante el juego.'
    ])">ACERCA DE LAS REGLAS</button>
    
    <button onclick="showModal([
      '<strong>C√ìMO UTILIZAR EL LIBRO DE LAS REGLAS</strong><br><br>No le√°is ninguno de los textos numerados de este libro antes de encontraros con una entrada en una de las cartas, en el tablero, en una ficha o en otro texto que no indique dicho n√∫mero de texto en particular.',
      'S√≥lo entonces ten√©is que buscar el n√∫mero del texto y resolverlo.<br><br><strong>No le√°is en voz alta los textos enteros</strong>; hacerlo es seguro que aburrir√° a otros jugadores y arruinar√° la intriga de la partida.',
      'Cuando un jugador resuelva el texto, lo mejor es que lo lea para s√≠ y despu√©s, lo mejor que pueda, <strong>narre lo sucedido con sus propias palabras</strong>.'
    ])">C√ìMO UTILIZAR EL LIBRO DE LAS REGLAS</button>
    
    <button onclick="showModal([
      '<strong>FICHAS EN BLANCO Y FICHAS A, B, C</strong><br><br>Muchos de los textos indican que hay que anotar una entrada de texto y un n√∫mero de texto en una ficha en Blanco.',
      'Cuando ello sucede, utilizad una de las fichas en Blanco que vienen con el juego y escribid en ella (por ejemplo, a bol√≠grafo) las palabras requeridas.',
      'Si las reglas requieren que retir√©is una ficha en Blanco, la pod√©is destruir por completo, puesto que la ficha en la que hab√©is escrito el mensaje no ser√° √∫til en ninguna partida futura.'
    ])">FICHAS EN BLANCO Y FICHAS A, B, C</button>
    
    <button onclick="showModal([
      '<strong>CONVERSACIONES DURANTE EL JUEGO</strong><br><br><strong><em>This War of Mine: el juego de tablero</em></strong> es un juego completamente cooperativo, que se basa en el relato que se cuenta y en las elecciones que se toman.',
      'La parte m√°s importante del juego es la comunicaci√≥n entre los jugadores: discutir juntos planes e ideas, interpretar, enriquecer la narraci√≥n, reflejar las situaciones de los Personajes, tanto con respecto a las reglas como a la historia.',
      'La supervivencia de vuestros Personajes es casi tan importante como la historia que cont√°is y c√≥mo la recordar√©is.'
    ])">CONVERSACIONES DURANTE EL JUEGO</button>
    
    <button onclick="showModal([
      '<strong>SEIS JUGADORES</strong><br><br>Antes de intentar una partida para seis jugadores, se recomienda que la mayor√≠a de los jugadores conozcan muy bien el juego.',
      'Con seis jugadores novatos, el ritmo puede decaer mucho al tener que hacer demasiadas pausas.'
    ])">SEIS JUGADORES</button>
  </div>

  <div class="input-container">
    <label for="textNumber">Introduce el n√∫mero del texto:</label>
    <input type="number" id="textNumber" min="1" max="9999">
    <button onclick="showText()">Mostrar texto</button>
  </div>

  <div class="text-container" id="textDisplay">
    <span id="close-text-btn" class="close" title="Cerrar texto">&times;</span>
    <div id="textContent"></div>
</div>

  <div class="font-size-container" style="margin-bottom: 60px;">
    <button onclick="changeFontSize(1)">Aumentar tama√±o de letra</button>
    <button onclick="changeFontSize(-1)">Disminuir tama√±o de letra</button>
  </div>

  <!-- Modal -->
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
      <div class="pagination-controls">
        <button id="prevPageBtn" onclick="changePage(-1)">Anterior</button>
        <span class="page-info" id="pageInfo">P√°gina 1/1</span>
        <button id="nextPageBtn" onclick="changePage(1)">Siguiente</button>
      </div>
    </div>
  </div>

  <!-- Reproductor de MP3 -->
  <div id="audio-player-container">
    <div id="player-controls">
      <div id="cover-art">
        <img id="cover-img" src="" alt="Car√°tula" />
      </div>
      <div id="player-details">
        <div id="song-info">
          <span id="time-display">00:00 / 00:00</span>
        </div>
        <select id="playlist"></select>
        <div id="control-buttons">
          <button id="prev-btn">‚è™</button>
          <button id="play-btn">‚èØ</button>
                    <button id="stop-btn">‚èπ</button>
          <button id="next-btn">‚è©</button>
        </div>
        <div id="additional-controls">
          <button id="repeat-btn" class="toggle-btn"  type="button" aria-label="Repetir: desactivado" data-repeat="none" data-state-label="Sin repetir" title="Repetir">üîÅ</button>
          <button id="shuffle-btn" class="toggle-btn" data-state-label="Shuffle OFF" type="button" aria-pressed="false" title="Aleatorio">üîÄ</button>
          <label for="volume-slider">Volumen</label>
          <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
        </div>
      </div>
    </div>
    <audio id="audio-player"></audio>
  </div>

  <!-- Carga el archivo de respaldo con los textos locales. Este archivo define window.TEXTS como objeto. -->
  <script src="texts-data.js"></script>

  <!--
    Para permitir que la aplicaci√≥n obtenga los textos directamente de una hoja de c√°lculo de Google Sheets
    y pueda sanitizarlos correctamente, cargamos las librer√≠as PapaParse (para analizar CSV)
    y DOMPurify (para limpiar el HTML y evitar inyecciones de c√≥digo). Estas librer√≠as se
    cargan desde un CDN y son necesarias para la opci√≥n de Google¬†Sheets.
  -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!--
    Definimos funciones auxiliares para sanitizar el HTML recibido de la hoja de c√°lculo y cargar
    din√°micamente los textos desde Google¬†Sheets. Si la carga del CSV falla (por ejemplo, porque
    no hay conexi√≥n a Internet), se deja intacto el objeto `window.TEXTS` definido en texts-data.js.
  -->
  <script>
    /*
     * Sanitiza una cadena de HTML permitiendo √∫nicamente etiquetas b√°sicas. Esto evita
     * la ejecuci√≥n de scripts potencialmente maliciosos cuando los textos son editados
     * por la comunidad en Google¬†Sheets. Solo se permiten etiquetas y atributos
     * necesarios para formatear texto (negritas, cursivas, saltos de l√≠nea, listas y enlaces).
     */
    function safeHTML(html) {
      // Extendemos los atributos permitidos para incluir clases y atributos de datos. Esto
      // permite usar enlaces estilizados como botones sin que DOMPurify elimine
      // los atributos necesarios (como `data-id` y `class`).
      return DOMPurify.sanitize(html || "", {
        ALLOWED_TAGS: ['strong','em','br','ul','ol','li','p','span','a'],
        ALLOWED_ATTR: ['href','title','target','rel','style','class','data-id']
      });
    }

    /**
     * Carga los textos desde una hoja de c√°lculo de Google Sheets publicada como CSV. Esta
     * funci√≥n usa fetch y PapaParse para descargar y analizar el contenido. Cada fila del
     * CSV debe tener una columna "id" (con el n√∫mero del texto) y una columna "html"
     * (con el contenido HTML). Si la descarga del CSV falla, no se modifica el objeto
     * `window.TEXTS`, de modo que se utilicen los textos locales de respaldo.
     */
    async function loadTexts() {
      const SHEETS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT6z8MOCn3sKvo4dfsNhhVkvi7RkM7c9IElP3qaQy5ld9xWdVGIL_W19uLWyropxBbgAoLWyy9G835U/pub?gid=0&single=true&output=csv";
      try {
        // A√±adimos un par√°metro "t" para evitar el uso de cach√© al solicitar el CSV.
        const response = await fetch(SHEETS_CSV_URL + "&t=" + Date.now());
        const csvText = await response.text();
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        const data = {};
        parsed.data.forEach(row => {
          const id = String(row.id || '').trim();
          const html = String(row.html || '');
          if (id) {
            data[id] = html;
          }
        });
        // Reemplazamos window.TEXTS por los datos cargados
        window.TEXTS = data;
      } catch (error) {
        // Si algo falla (por ejemplo, sin conexi√≥n), dejamos intacto window.TEXTS.
        console.warn('No se pudo cargar el CSV de Google Sheets, se usar√° el respaldo local.', error);
      }
    }

    // Cargamos los textos al cargar la p√°gina. De este modo, al actualizar la hoja
    // de c√°lculo, los cambios aparecer√°n cuando el usuario recargue el HTML.
    document.addEventListener('DOMContentLoaded', loadTexts);
  </script>

  <script>
    // Variables para controlar la paginaci√≥n
    let currentPages = [];
    let currentPage = 0;

    
function renderHTML(target, html) {
    // Centralized HTML rendering point (future sanitization can go here)
    target.innerHTML = html;
}

function showModal(pages) {
      // Pasamos un array de p√°ginas directamente para evitar partir por '<hr>'
      currentPages = Array.isArray(pages) ? pages : [String(pages)];
      currentPage = 0;
      updateModalContent();
      document.getElementById('myModal').style.display = "block";
      document.body.style.overflow = "hidden";
    }

    function updateModalContent() {
      const modalContent = document.getElementById('modalContent');
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');

      modalContent.innerHTML = currentPages[currentPage] || "Contenido no disponible";
      pageInfo.textContent = `P√°gina ${currentPage + 1}/${currentPages.length}`;

      // Mostrar/ocultar botones seg√∫n corresponda
      if (prevBtn) prevBtn.style.display = (currentPage === 0) ? 'none' : '';
      if (nextBtn) nextBtn.style.display = (currentPage === currentPages.length - 1) ? 'none' : '';
    }

    function changePage(delta) {
      currentPage = Math.max(0, Math.min(currentPages.length - 1, currentPage + delta));
      updateModalContent();
    }

    function closeModal() {
      document.getElementById('myModal').style.display = "none";
      document.body.style.overflow = "auto";
    }

    const texts = window.TEXTS || {};


    function showText(textNumber = null) {
      const inputField = document.getElementById('textNumber');
      const textDisplay = document.getElementById('textDisplay');
      const textContent = document.getElementById('textContent');
      const closeBtn = document.getElementById('close-text-btn');

      if (!textDisplay || !textContent) return;

      // Obtiene la clave (trim para evitar espacios)
      let key = null;
      if (textNumber !== null && textNumber !== undefined) {
        key = String(textNumber).trim();
        if (inputField) inputField.value = textNumber;
      } else if (inputField) {
        const v = String(inputField.value || "").trim();
        if (v) key = v;
      }

      // Si no hay n√∫mero, ocultar visor por completo
      if (!key) {
        textContent.innerHTML = "";
        if (closeBtn) closeBtn.style.display = "none";
        textDisplay.style.display = "none";
        return;
      }

      // Mostrar contenido + X
      // Buscamos primero en los textos cargados din√°micamente desde Google¬†Sheets (window.TEXTS),
      // luego en el objeto de respaldo `texts` definido en texts-data.js. Tras obtener el HTML
      // aplicamos safeHTML para evitar la ejecuci√≥n de scripts inesperados.
      let content = null;
      if (window.TEXTS && window.TEXTS.hasOwnProperty(key)) {
        content = window.TEXTS[key];
      } else if (typeof texts !== 'undefined' && texts && texts.hasOwnProperty(key)) {
        content = texts[key];
      }
      textContent.innerHTML = safeHTML(content || 'Texto no encontrado.');
      textDisplay.style.display = 'block';
      if (closeBtn) closeBtn.style.display = 'block';
    }

function changeFontSize(delta) {
      const textDisplay = document.getElementById('textDisplay');
      const currentSize = parseFloat(window.getComputedStyle(textDisplay).fontSize);
      textDisplay.style.fontSize = `${currentSize + delta}px`;
    }

    window.onclick = function(event) {
      const modal = document.getElementById('myModal');
      if (event.target === modal) closeModal();
    };

    // C√≥digo del reproductor de audio (se mantiene igual)
    const songs = [
      { title: "01 - Not a game - Intro", file: "twom-files/track01.mp3", cover: "twom-files/cover.jpg" },
      { title: "02 - This War of mine", file: "twom-files/track02.mp3", cover: "twom-files/cover.jpg" },
      { title: "03 - Some place we called home", file: "twom-files/track03.mp3", cover: "twom-files/cover.jpg" },
      { title: "04 - When the night comes", file: "twom-files/track04.mp3", cover: "twom-files/cover.jpg" },
      { title: "05 - These cold days", file: "twom-files/track05.mp3", cover: "twom-files/cover.jpg" },
      { title: "06 - No good choice", file: "twom-files/track06.mp3", cover: "twom-files/cover.jpg" },
      { title: "07 - We keep going", file: "twom-files/track07.mp3", cover: "twom-files/cover.jpg" },
      { title: "08 - Things right and wrong", file: "twom-files/track08.mp3", cover: "twom-files/cover.jpg" },
      { title: "09 - Alone", file: "twom-files/track09.mp3", cover: "twom-files/cover.jpg" },
      { title: "10 - Still alive inside", file: "twom-files/track10.mp3", cover: "twom-files/cover.jpg" },
      { title: "11 - A girl from Pogoren", file: "twom-files/track11.mp3", cover: "twom-files/cover.jpg" },
      { title: "12 - Never forget", file: "twom-files/track12.mp3", cover: "twom-files/cover.jpg" }
    ];

    let currentIndex = 0;
    let loopMode = "none"; // "none", "all", "one"
    let shuffleMode = false;

    const audioPlayer = document.getElementById('audio-player');
    const playlistSelect = document.getElementById('playlist');
    const coverImg = document.getElementById('cover-img');
    const playBtn = document.getElementById('play-btn');    const stopBtn = document.getElementById('stop-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    
    function updatePlayButton() {
      // When playing, show pause icon; when paused, show play icon
      playBtn.textContent = audioPlayer.paused ? "‚ñ∂Ô∏è" : "‚è∏";
    }
function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return (min < 10 ? "0" + min : min) + ":" + (sec < 10 ? "0" + sec : sec);
    }

    audioPlayer.addEventListener("play", updatePlayButton);
    audioPlayer.addEventListener("pause", updatePlayButton);
    audioPlayer.addEventListener("ended", updatePlayButton);

    audioPlayer.addEventListener("timeupdate", () => {
      const current = audioPlayer.currentTime;
      const total = audioPlayer.duration;
      if (!isNaN(total)) {
        document.getElementById("time-display").textContent = formatTime(current) + " / " + formatTime(total);
      }
    });

    audioPlayer.addEventListener("loadedmetadata", () => {
      const total = audioPlayer.duration;
      if (!isNaN(total)) {
        document.getElementById("time-display").textContent = formatTime(audioPlayer.currentTime) + " / " + formatTime(total);
      }
    });

    function loadSong(index) {
      currentIndex = index;
      const song = songs[index];
      audioPlayer.src = song.file;
      coverImg.src = song.cover;
      updatePlaylist();
      updatePlayButton();
    }

    function updatePlaylist() {
      playlistSelect.innerHTML = "";
      songs.forEach((song, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = song.title;
        if (index === currentIndex) {
          option.classList.add("playing");
          option.selected = true;
        }
        playlistSelect.appendChild(option);
      });
    }

    playlistSelect.addEventListener("change", function() {
      loadSong(parseInt(this.value));
      audioPlayer.play();
    });

    playBtn.addEventListener("click", () => {
      if (audioPlayer.paused) {
        audioPlayer.play();
      } else {
        audioPlayer.pause();
      }
    });

    stopBtn.addEventListener("click", () => {
      audioPlayer.pause();
      audioPlayer.currentTime = 0;
      updatePlayButton();
    });

    prevBtn.addEventListener("click", () => {
      if (shuffleMode) {
        let randomIndex = Math.floor(Math.random() * songs.length);
        while (randomIndex === currentIndex && songs.length > 1) {
          randomIndex = Math.floor(Math.random() * songs.length);
        }
        loadSong(randomIndex);
        audioPlayer.play();
      } else if (currentIndex > 0) {
        loadSong(currentIndex - 1);
        audioPlayer.play();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (shuffleMode) {
        let randomIndex = Math.floor(Math.random() * songs.length);
        while (randomIndex === currentIndex && songs.length > 1) {
          randomIndex = Math.floor(Math.random() * songs.length);
        }
        loadSong(randomIndex);
        audioPlayer.play();
      } else if (currentIndex < songs.length - 1) {
        loadSong(currentIndex + 1);
        audioPlayer.play();
      } else if (loopMode === "all") {
        loadSong(0);
        audioPlayer.play();
      }
    });

    audioPlayer.addEventListener("ended", () => {
      if (loopMode === "one") {
        // Repeat current track
        audioPlayer.currentTime = 0;
        audioPlayer.play();
        return;
      }

      if (shuffleMode) {
        let randomIndex = Math.floor(Math.random() * songs.length);
        while (randomIndex === currentIndex && songs.length > 1) {
          randomIndex = Math.floor(Math.random() * songs.length);
        }
        loadSong(randomIndex);
        audioPlayer.play();
        return;
      }

      if (currentIndex < songs.length - 1) {
        loadSong(currentIndex + 1);
        audioPlayer.play();
      } else if (loopMode === "all") {
        loadSong(0);
        audioPlayer.play();
      } else {
        // No repeat: stop at end
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
      }
    });

    const repeatBtn = document.getElementById("repeat-btn");
    const shuffleBtn = document.getElementById("shuffle-btn");

    function updateRepeatButton() {
      if (!repeatBtn) return;
      const mode = repeatBtn.getAttribute("data-repeat") || "none";

      // Reset
      repeatBtn.classList.remove("active", "is-active");

      if (mode === "none") {
        repeatBtn.textContent = "üîÅ";
        repeatBtn.setAttribute("aria-label", "Repetir: sin repetir");
        repeatBtn.setAttribute("title", "Repetici√≥n: Sin repetir");
        repeatBtn.setAttribute("data-state-label", "Sin repetir");
      } else if (mode === "all") {
        repeatBtn.textContent = "üîÅ";
        repeatBtn.setAttribute("aria-label", "Repetir: lista");
        repeatBtn.setAttribute("title", "Repetici√≥n: Repetir lista");
        repeatBtn.setAttribute("data-state-label", "Repetir lista");
        repeatBtn.classList.add("active", "is-active");
      } else {
        repeatBtn.textContent = "üîÇ";
        repeatBtn.setAttribute("aria-label", "Repetir: pista");
        repeatBtn.setAttribute("title", "Repetici√≥n: Repetir pista");
        repeatBtn.setAttribute("data-state-label", "Repetir pista");
        repeatBtn.classList.add("active", "is-active");
      }
    }

    function updateShuffleButton() {
      if (!shuffleBtn) return;
      shuffleBtn.classList.toggle("active", !!shuffleMode);
      shuffleBtn.classList.toggle("is-active", !!shuffleMode);
      shuffleBtn.setAttribute("aria-pressed", shuffleMode ? "true" : "false");
      shuffleBtn.setAttribute("title", shuffleMode ? "Shuffle: ON" : "Shuffle: OFF");
      shuffleBtn.setAttribute("data-state-label", shuffleMode ? "Shuffle ON" : "Shuffle OFF");
    }



function setRepeatMode(mode) {
      loopMode = mode;
      if (repeatBtn) repeatBtn.setAttribute("data-repeat", mode);
      updateRepeatButton();
    }

    if (repeatBtn) {
      repeatBtn.addEventListener("click", () => {
        const current = repeatBtn.getAttribute("data-repeat") || "none";
        const next = (current === "none") ? "all" : (current === "all") ? "one" : "none";
        setRepeatMode(next);
      });
      updateRepeatButton();
    }

    if (shuffleBtn) {
      shuffleBtn.addEventListener("click", () => {
        shuffleMode = !shuffleMode;
        updateShuffleButton();
      });
    }
document.getElementById("volume-slider").addEventListener("input", function(){
      audioPlayer.volume = parseFloat(this.value);
    });

    loadSong(0);
  
// Event delegation for dynamic modal buttons
document.addEventListener("click", function(e) {
    const btn = e.target.closest("[data-show-text]");
    if (!btn) return;

    const textNumber = btn.getAttribute("data-show-text");
    if (textNumber) {
        showText(parseInt(textNumber));
        closeModal();
    }
});

// Delegaci√≥n de eventos para enlaces num√©ricos generados desde Google Sheets. Cuando un
// usuario hace clic en un enlace con atributo `data-id`, se captura el evento,
// se previene la acci√≥n por defecto y se llama a showText con el n√∫mero
// correspondiente. Esto permite que los n√∫meros importados de la hoja de c√°lculo
// se comporten como botones de navegaci√≥n.
document.addEventListener("click", function(e) {
    const link = e.target.closest("a[data-id]");
    if (!link) return;
    e.preventDefault();
    const id = link.getAttribute("data-id");
    if (id) {
      showText(parseInt(id));
    }
});







// Cerrar visor de textos con la "X"
document.addEventListener("click", function(e) {
  if (e.target && e.target.id === "close-text-btn") {
    const textDisplay = document.getElementById("textDisplay");
    const textContent = document.getElementById("textContent");
    const closeBtn = document.getElementById("close-text-btn");
    const inputField = document.getElementById("textNumber");

    if (textContent) textContent.innerHTML = "";
    if (closeBtn) closeBtn.style.display = "none";
    if (textDisplay) textDisplay.style.display = "none";
    if (inputField) inputField.value = "";
  }
});

</script>
</body>
</html>
